{"version":3,"sources":["../../main.js"],"names":["Distance","require","ClusterInit","eudist","mandist","absdist","dist","kmrand","kmpp","MAX","fill","len","val","v","i","test","point","fndist","ks","centroids","k","length","min","Infinity","idx","j","centroid","skmeans","data","maxit","fixedclusters","old","idxs","conv","it","vlen","count","fixedcluster_inds","Set","sort","slice","fixedclusters_set","sum","vsum","vect","h","has","ksj","sumj","cj","oldj","module","exports"],"mappings":"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","sourcesContent":["/*jshint esversion: 6 */\n\nconst\n\tDistance = require(\"./distance.js\"),\n\tClusterInit = require(\"./kinit.js\"),\n\teudist = Distance.eudist,\n\tmandist = Distance.mandist,\n\tabsdist = Distance.dist,\n\tkmrand = ClusterInit.kmrand,\n\tkmpp = ClusterInit.kmpp;\n\nconst MAX = 10000;\n\n/**\n * Inits an array with values\n */\nfunction fill(len,val,v) {\n\tv = v || [];\n\tfor(let i=0;i<len;i++) v[i] = val;\n\treturn v;\n}\n\nfunction test(point, fndist) {\n\tlet\n\t\tks = this.centroids,\n\t\tk = ks.length;\n\n\t// For each value in data, find the nearest centroid\n\tlet min = Infinity, idx = 0;\n\tfor(let j=0;j<k;j++) {\n\t\t// Custom, Multidimensional or unidimensional\n\t\tlet dist =\tfndist? fndist(point,ks[j]) : eudist(point,ks[j])\n\n\t\tif(dist<=min) {\n\t\t\tmin = dist;\n\t\t\tidx = j;\n\t\t}\n\t}\n\n\treturn {\n\t\tidx, centroid:ks[idx]\n\t}\n}\n\nfunction skmeans(data,k,maxit,fixedclusters) {\n\t// fixedclusters looks like [0, 1, 0, 0, -1, -1, -1], e.g.,\n\t// to indicate that 0, 2, 3 should stay clustered and \n\t// 1 should stay clustered and the last three data points\n\t// should go in some cluster, either one of the first two\n\t// or a new one\n\tvar ks = [], old = [], idxs = [], dist = [];\n\tvar conv = false, it = maxit || MAX;\n\tvar len = data.length, vlen = data[0].length; \n\tvar count = [];\n\t\n\tfor (let j=0;j<k;j++){\n\t\tks[j] = [];\n\t\tcount[j] = 0;\n\t}\n\t\n\t// fix centers based on pre-specified clusters\n\tif(fixedclusters) {\n\t\t\n\t\t// determine which clusters are fixed:\n\t\tvar fixedcluster_inds = [...new Set(fixedclusters)].sort().slice(1);\n\t\tvar fixedclusters_set = new Set(fixedcluster_inds);\n\t\t\n\t\t// set up zero vectors to store means\n\t\tvar sum = []; \n\t\tfor(let j=0;j<k;j++) {\n\t\t\t\tsum[j] = fill(vlen,0,sum[j]);\n\t\t}\n\n\t\t// Sum, values, and count for each centroid\n\t\tfor(let i=0;i<len;i++) {\n\t\t\tif (fixedclusters[i] != -1) {\n\t\t\t\tlet\tidx = fixedclusters[i],\t\t// Centroid for that item\n\t\t\t\t\t\tvsum = sum[idx],\t// Sum values for this centroid\n\t\t\t\t\t\tvect = data[i];\t\t// Current vector\n\n\t\t\t\t// Accumulate value on the centroid for current vector\n\t\t\t\tfor(let h=0;h<vlen;h++) {\n\t\t\t\t\tvsum[h] += vect[h];\n\t\t\t\t}\n\t\t\t\tcount[idx]++;\n\t\t\t}\n\t\t}\n\t\t// Calculate the average for each centroid\n\t\tfor(let j=0;j<k;j++) {\n\t\t\tif (fixedclusters_set.has(j)) {\n\t\t\t\tlet ksj = ks[j],\t\t// Current centroid\n\t\t\t\t\t\tsumj = sum[j],\t// Accumulated centroid values\n\t\t\t\t\t\tcj = count[j];\t// Number of elements for this centroid\n\t\t\t\tfor(let h=0;h<vlen;h++) {\n\t\t\t\t\tksj[h] = (sumj[h])/(cj) || 0;\t// centroid\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\telse {\n\t\tvar fixedclusters = fill(len, -1);\n\t\tvar fixedcluster_inds = [];\n\t\tvar fixedclusters_set = new Set();\n\t}\n\t\n\t// Choose initial points for the free clusters in a smart way\n\tkmpp(data, k, ks);\n\n\tdo {\n\t\t// Reset count\n\t\tfill(k,0,count);\n\n\t\t// For each non-fixed value in data, find the nearest centroid\n\t\tfor(let i=0;i<len;i++) {\n\t\t\tlet min = Infinity, idx = 0;\n\t\t\tif (fixedclusters[i] == -1) { // -1 indicates a non-fixed point\n\t\t\t\tfor(let j=0;j<k;j++) {\n\t\t\t\t\tvar dist = eudist(data[i],ks[j]);\n\t\t\t\t\t\n\t\t\t\t\tif(dist<=min) {\n\t\t\t\t\t\tmin = dist;\n\t\t\t\t\t\tidx = j;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tidx = fixedclusters[i]; \n\t\t\t}\n\t\t\tidxs[i] = idx;\t// Index of the selected centroid for that value\n\t\t\tcount[idx]++;\t\t// Number of values for this centroid\n\t\t}\t\t\n\n\t\t// Recalculate centroids\n\t\tvar sum = [], old = [];\n\t\tfor(let j=0;j<k;j++) {\n\t\t\t\tsum[j] = fill(vlen,0,sum[j]);\n\t\t\t\told[j] = ks[j];\n\t\t}\n\t\t\n\t\tfor(let j=0;j<k;j++) {\n\t\t\tif (!fixedclusters_set.has(j)) {\n\t\t\t\tks[j] = [];\n\t\t\t}\n\t\t}\n\n\t\t// Sum values and count for each centroid\n\t\tfor(let i=0;i<len;i++) {\n\t\t\tlet\tidx = idxs[i],\t\t// Centroid for that item\n\t\t\t\t\tvsum = sum[idx],\t// Sum values for this centroid\n\t\t\t\t\tvect = data[i];\t\t// Current vector\n\n\t\t\t// Accumulate value on the centroid for current vector\n\t\t\tfor(let h=0;h<vlen;h++) {\n\t\t\t\tvsum[h] += vect[h];\n\t\t\t}\n\t\t}\n\t\t\n\t\t// Calculate the average for each centroid\n\t\tconv = true;\n\t\tfor(let j=0;j<k;j++) {\n\t\t\tif (!fixedclusters_set.has(j)) {\n\t\t\t\tlet ksj = ks[j],\t\t// Current centroid\n\t\t\t\t\t\tsumj = sum[j],\t// Accumulated centroid values\n\t\t\t\t\t\toldj = old[j], \t// Old centroid value\n\t\t\t\t\t\tcj = count[j];\t// Number of elements for this centroid\n\t\t\t\t// New average\n\t\t\t\tfor(let h=0;h<vlen;h++) {\n\t\t\t\t\tksj[h] = (sumj[h])/(cj) || 0;\t// New centroid\n\t\t\t\t}\n\t\t\t\t// Determine whether centroids have moved\n\t\t\t\tif(conv) {\n\t\t\t\t\tfor(let h=0;h<vlen;h++) {\n\t\t\t\t\t\tif(oldj[h]!=ksj[h]) {\n\t\t\t\t\t\t\tconv = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tconv = conv || (--it<=0);\n\t} while(!conv);\n\n\treturn {\n\t\tit : (maxit || MAX) - it,\n\t\tk : k,\n\t\tidxs : idxs,\n\t\tcentroids : ks,\n\t\ttest : test\n\t};\n}\n\nmodule.exports = skmeans;\n"],"file":"main.js"}